---
title: "Results"
author: "Shira Salingre"
output: 
  html_document:
    theme: united
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
---

```{r setup, include=FALSE}
source("scripts/pckgs_preps.R")
source("scripts/model_func.R")
library(usethis)
library(formattable)

# For mean coefficient tables
neg_col <- '#3399CC'
pos_col <- '#FF3333'
col_formatter <- formatter("span",
                           style = x ~ style(color =
                                               ifelse(x > 0, pos_col, ifelse(x < 0, neg_col, "black"))))

```

In order to examine the association between species and how this association changes along environmental gradient, I chose three groups of representative fish species: groupers (Epinephelus species + Serranus species), Seabream species and herbivore species.  

I'm using the MRF-based model from `MRFcov` package (Clark _et al._ [^1]) to detemine the level and direction of species association in each group.  

MPAs are defined as unprotected (enforcement level 0-1) or protected (2-3); therefore this is not a gradient.  
<!--Does this affect the model?-->

Connectance (Delams _et al._ [^2]) is a measure of comparison between networks. Essentially, it describes the level of connectedness of species in the network as a proportion the potential associations in the network:

    C0 = [total # of edges] / [total # of nodes^2 (total possible connections)]

L = number of edges (associations)  
S = number of nodes (species)  
M = S^2  
connectance (C0) = L/M  


# Groupers
```{r warning=FALSE, fig.align='center', fig.show='hold'}

## Create matrices --------------------------------------------------------
# Temperature and depth ---------------------------------------------------
grps_temp_dep <- create_spp_mat(dataset = med_raw, basin = all_med,
                                group = groupers, covariate = c("tmean_reg", "depth_reg"))

# Temperature -------------------------------------------------------------
grps_temp <- create_spp_mat(dataset = med_raw, basin = all_med,
                            group = groupers, covariate = "tmean_reg")

# MPAs and depth ----------------------------------------------------------
grps_mpa_dep <- create_spp_mat(dataset = med_raw, basin = all_med,
                               group = groupers, covariate = c("mpa", "depth_reg"))

# MPAs --------------------------------------------------------------------
grps_mpa <- create_spp_mat(dataset = med_raw, basin = all_med,
                           group = groupers, covariate = "mpa")

## Run models -------------------------------------------------------------

# Temperature and depth ---------------------------------------------------

grps_temp_dep_model <- run_mod(species_mat = grps_temp_dep, n_covs = 2, 
                           family = "gaussian", coords = coords_all)
plotMRF_hm(grps_temp_dep_model$mod, main = "Groupers and temperature (incl. depth) - association coefficients")

# MPAs and depth ----------------------------------------------------------

grps_mpa_dep_model <- run_mod(species_mat = grps_mpa_dep, n_covs = 2,
                          family = "gaussian", coords = coords_all)
plotMRF_hm(grps_mpa_dep_model$mod, main = "Groupers and MPAs (incl. depth) - association coefficients")


## Networks ---------------------------------------------------------------

# Temperature -------------------------------------------------------------
# without depth
grps_temp_cats <- categorise_cov(species = grps_temp, covariate = "tmean_reg")
grps_temp_cat_nested <- nested_data(categorised_data = grps_temp_cats)
grps_temp_cat_model <- get_model(data = grps_temp, ncov = 1)
grps_temp_nested_mod <- nested_models(nested_df = grps_temp_cat_nested)
grps_temp_nested_plot <- grps_temp_nested_mod %>% mutate(plot = map(model, get_graph))
grps_temp_graph <- plot_multi_graphs(nested_df = grps_temp_nested_plot, n_graphs = 3)

# Connectance 
(grps_temp_connect <- tibble(connectance = unlist(grps_temp_nested_mod$connectance)) %>% 
    add_column(network = factor(c("low", "medium", "high"))) %>% 
    select(network, connectance))

# MPAs --------------------------------------------------------------------
# without depth
grps_mpa_cat_nested <- nested_data(categorised_data = as.data.frame(grps_mpa))
grps_mpa_cat_model <- get_model(data = grps_mpa, ncov = 1)
grps_mpa_nested_mod <- nested_models(nested_df = grps_mpa_cat_nested)
grps_mpa_nested_plot <- grps_mpa_nested_mod %>% mutate(plot = map(model, get_graph))
grps_mpa_graph <- plot_multi_graphs(nested_df = grps_mpa_nested_plot, n_graphs = 2)

# Connectance 
(grps_mpa_connect <- tibble(connectance = unlist(grps_mpa_nested_mod$connectance)) %>% 
  add_column(network = factor(c("outside MPA", "inside MPA"))) %>% 
  select(network, connectance))


## Stationarity -----------------------------------------------------------
# Relative importance
grps_temp_relimp <- sapply(X = grps_temp_dep_model$mod$key_coefs, rel_imp, cov = ("tmean_reg")) %>% 
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

grps_mpa_relimp <- sapply(X = grps_mpa_dep_model$mod$key_coefs, rel_imp, cov = "mpa") %>% 
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

(grps_relimp <- grps_temp_relimp %>%
  left_join(grps_mpa_relimp, by = "species"))

# Mean coefficients
grps_temp_meancoefs <- sapply(X = grps_temp_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

grps_mpa_meancoefs <- sapply(X = grps_mpa_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

grps_spp_meancoef <- grps_temp_meancoefs %>%
  left_join(grps_mpa_meancoefs, by = "species")

formattable(grps_spp_meancoef, align = c("l","c"), list(
  `species` = formatter("span", style = ~ style(color = "grey", font.weight = "bold")), 
  `temp_model` = col_formatter,
  `mpa_model` = col_formatter
))


```

Most grouper species are affected mainly by other species occurrence rather than covariates (temperature, MPAs and depth).  
_Mycteroperca rubra_ shows a different pattern whereas temperature and MPAs are stronger factors than biotic interactions.  

# Seabreams
```{r warning=FALSE, fig.align='center'}

## Create matrices --------------------------------------------------------
# Temperature and depth ---------------------------------------------------
dip_temp_dep <- create_spp_mat(dataset = med_raw, basin = all_med,
                                group = diplodus, covariate = c("tmean_reg", "depth_reg"))

# Temperature -------------------------------------------------------------
dip_temp <- create_spp_mat(dataset = med_raw, basin = all_med,
                            group = diplodus, covariate = "tmean_reg")

# MPAs and depth ----------------------------------------------------------
dip_mpa_dep <- create_spp_mat(dataset = med_raw, basin = all_med,
                               group = diplodus, covariate = c("mpa", "depth_reg"))

# MPAs --------------------------------------------------------------------
dip_mpa <- create_spp_mat(dataset = med_raw, basin = all_med,
                           group = diplodus, covariate = "mpa")

## Run models -------------------------------------------------------------

# Temperature and depth ---------------------------------------------------

dip_temp_dep_model <- run_mod(species = dip_temp_dep, n_covs = 2,
                           family = "gaussian", coords = coords_all)
plotMRF_hm(dip_temp_dep_model$mod, main = "Seabreams and temperature (incl. depth) - association coefficients")

# MPAs and depth ----------------------------------------------------------

dip_mpa_dep_model <- run_mod(species = dip_mpa_dep, n_covs = 2,
                          family = "gaussian", coords = coords_all)
plotMRF_hm(dip_mpa_dep_model$mod, main = "Seabreams and MPAs (incl. depth) - association coefficients")


## Networks ---------------------------------------------------------------

# Temperature -------------------------------------------------------------
# without depth
dip_temp_cats <- categorise_cov(species = dip_temp, covariate = "tmean_reg")
dip_temp_cat_nested <- nested_data(categorised_data = dip_temp_cats)
dip_temp_cat_model <- get_model(data = dip_temp, ncov = 1)
dip_temp_nested_mod <- nested_models(nested_df = dip_temp_cat_nested)
dip_temp_nested_plot <- dip_temp_nested_mod %>% mutate(plot = map(model, get_graph))
dip_temp_graph <- plot_multi_graphs(nested_df = dip_temp_nested_plot, n_graphs = 3)

# Connectance 
(dip_temp_connect <- tibble(connectance = unlist(dip_temp_nested_mod$connectance)) %>% 
    add_column(network = factor(c("low", "medium", "high"))) %>% 
    select(network, connectance))

# MPAs --------------------------------------------------------------------
# without depth
dip_mpa_cat_nested <- nested_data(categorised_data = as.data.frame(dip_mpa))
dip_mpa_cat_model <- get_model(data = dip_mpa, ncov = 1)
dip_mpa_nested_mod <- nested_models(nested_df = dip_mpa_cat_nested)
dip_mpa_nested_plot <- dip_mpa_nested_mod %>% mutate(plot = map(model, get_graph))
dip_mpa_graph <- plot_multi_graphs(nested_df = dip_mpa_nested_plot, n_graphs = 2)

# Connectance 
(dip_mpa_connect <- tibble(connectance = unlist(dip_mpa_nested_mod$connectance)) %>% 
  add_column(network = factor(c("outside MPA", "inside MPA"))) %>% 
  select(network, connectance))


## Stationarity -----------------------------------------------------------
# Relative importance
dip_temp_relimp <- sapply(X = dip_temp_dep_model$mod$key_coefs, rel_imp, cov = ("tmean_reg")) %>% 
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

dip_mpa_relimp <- sapply(X = dip_mpa_dep_model$mod$key_coefs, rel_imp, cov = "mpa") %>% 
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

(dip_relimp <- dip_temp_relimp %>%
  left_join(dip_mpa_relimp, by = "species"))

# Mean coefficients
dip_temp_meancoefs <- sapply(X = dip_temp_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

dip_mpa_meancoefs <- sapply(X = dip_mpa_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

dip_spp_meancoef <- dip_temp_meancoefs %>%
  left_join(dip_mpa_meancoefs, by = "species")

formattable(dip_spp_meancoef, align = c("l","c"), list(
  `species` = formatter("span", style = ~ style(color = "grey", font.weight = "bold")), 
  `temp_model` = col_formatter,
  `mpa_model` = col_formatter
))


```

Seabream species are not greatly affected by other species accept _Diplodus cervinus_, which seem to show a different pattern with temperature and depth effects.


# Herbivores in western basin
```{r warning=FALSE, fig.align='center'}
herb_west <- c("Sparisoma.cretense", "Sarpa.salpa", "Siganus.luridus")

## Create matrices --------------------------------------------------------
# Temperature and depth ---------------------------------------------------
herb_west_temp_dep <- create_spp_mat(dataset = med_raw, basin = west,
                                group = herb_west, covariate = c("tmean_reg", "depth_reg"))

# Temperature -------------------------------------------------------------
herb_west_temp <- create_spp_mat(dataset = med_raw, basin = west,
                            group = herb_west, covariate = "tmean_reg")

# MPAs and depth ----------------------------------------------------------
herb_west_mpa_dep <- create_spp_mat(dataset = med_raw, basin = west,
                               group = herb_west, covariate = c("mpa", "depth_reg"))

# MPAs --------------------------------------------------------------------
herb_west_mpa <- create_spp_mat(dataset = med_raw, basin = west,
                           group = herb_west, covariate = "mpa")

## Run models -------------------------------------------------------------

# Temperature and depth ---------------------------------------------------

herb_west_temp_dep_model <- run_mod(species_mat = herb_west_temp_dep, n_covs = 2,
                           family = "gaussian", coords = coords_w)
plotMRF_hm(herb_west_temp_dep_model$mod, main = "Herbivores and temperature (incl. depth) in the west - association coefficients")

# MPAs and depth ----------------------------------------------------------

herb_west_mpa_dep_model <- run_mod(species_mat = herb_west_mpa_dep, n_covs = 2,
                          family = "gaussian", coords = coords_w)
plotMRF_hm(herb_west_mpa_dep_model$mod, main = "Herbivores and MPAs (incl. depth) in the west - association coefficients")


## Networks ---------------------------------------------------------------

# Temperature -------------------------------------------------------------
# without depth
herb_west_temp_cats <- categorise_cov(species_mat = herb_west_temp, covariate = "tmean_reg")
herb_west_temp_cat_nested <- nested_data(categorised_data = herb_west_temp_cats)
herb_west_temp_cat_model <- get_model(data = herb_west_temp, ncov = 1)
herb_west_temp_nested_mod <- nested_models(nested_df = herb_west_temp_cat_nested)
herb_west_temp_nested_plot <- herb_west_temp_nested_mod %>% mutate(plot = map(model, get_graph))
# herb_west_temp_graph <- plot_multi_graphs(nested_df = herb_west_temp_nested_plot, n_graphs = 3)
ui_oops("Problem with igraph here :(")

# Connectance 
(herb_west_temp_connect <- tibble(connectance = unlist(herb_west_temp_nested_mod$connectance)) %>% 
    add_column(network = factor(c("low", "medium", "high"))) %>% 
    select(network, connectance))

# MPAs --------------------------------------------------------------------
# without depth
herb_west_mpa_cat_nested <- nested_data(categorised_data = as.data.frame(herb_west_mpa))
herb_west_mpa_cat_model <- get_model(data = herb_west_mpa, ncov = 1)
herb_west_mpa_nested_mod <- nested_models(nested_df = herb_west_mpa_cat_nested)
herb_west_mpa_nested_plot <- herb_west_mpa_nested_mod %>% mutate(plot = map(model, get_graph))
# herb_west_mpa_graph <- plot_multi_graphs(nested_df = herb_west_mpa_nested_plot, n_graphs = 2)
ui_oops("Problem with igraph here :(")

# Connectance 
(herb_west_mpa_connect <- tibble(connectance = unlist(herb_west_mpa_nested_mod$connectance)) %>% 
  add_column(network = factor(c("outside MPA", "inside MPA"))) %>% 
  select(network, connectance))


## Stationarity -----------------------------------------------------------
# Relative importance
herb_west_temp_relimp <- sapply(X = herb_west_temp_dep_model$mod$key_coefs, rel_imp, cov = ("tmean_reg")) %>% 
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

herb_west_mpa_relimp <- sapply(X = herb_west_mpa_dep_model$mod$key_coefs, rel_imp, cov = "mpa") %>% 
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

(herb_west_relimp <- herb_west_temp_relimp %>%
  left_join(herb_west_mpa_relimp, by = "species"))

# Mean coefficients
herb_west_temp_meancoefs <- sapply(X = herb_west_temp_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

herb_west_mpa_meancoefs <- sapply(X = herb_west_mpa_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

herb_west_spp_meancoef <- herb_west_temp_meancoefs %>%
  left_join(herb_west_mpa_meancoefs, by = "species")

formattable(herb_west_spp_meancoef, align = c("l","c"), list(
  `species` = formatter("span", style = ~ style(color = "grey", font.weight = "bold")), 
  `temp_model` = col_formatter,
  `mpa_model` = col_formatter
))

```

# Herbivores in both basins  
```{r warning=FALSE, fig.align='center'}

## Create matrices --------------------------------------------------------
# Temperature and depth ---------------------------------------------------
herb_temp_dep <- create_spp_mat(dataset = med_raw, basin = all_med,
                                group = herbivores, covariate = c("tmean_reg", "depth_reg"))

# Temperature -------------------------------------------------------------
herb_temp <- create_spp_mat(dataset = med_raw, basin = all_med,
                            group = herbivores, covariate = "tmean_reg")

# MPAs and depth ----------------------------------------------------------
herb_mpa_dep <- create_spp_mat(dataset = med_raw, basin = all_med,
                               group = herbivores, covariate = c("mpa", "depth_reg"))

# MPAs --------------------------------------------------------------------
herb_mpa <- create_spp_mat(dataset = med_raw, basin = all_med,
                           group = herbivores, covariate = "mpa")

## Run models -------------------------------------------------------------

# Temperature and depth ---------------------------------------------------

herb_temp_dep_model <- run_mod(species = herb_temp_dep, n_covs = 2,
                           family = "gaussian", coords = coords_all)
plotMRF_hm(herb_temp_dep_model$mod, main = "Herbivores and temperature (incl. depth) - association coefficients")

# MPAs and depth ----------------------------------------------------------

herb_mpa_dep_model <- run_mod(species = herb_mpa_dep, n_covs = 2,
                          family = "gaussian", coords = coords_all)
plotMRF_hm(herb_mpa_dep_model$mod, main = "Herbivores and MPAs (incl. depth) - association coefficients")


## Networks ---------------------------------------------------------------

# Temperature -------------------------------------------------------------
# without depth
herb_temp_cats <- categorise_cov(species = herb_temp, covariate = "tmean_reg")
herb_temp_cat_nested <- nested_data(categorised_data = herb_temp_cats)
herb_temp_cat_model <- get_model(data = herb_temp, ncov = 1)
herb_temp_nested_mod <- nested_models(nested_df = herb_temp_cat_nested)
herb_temp_nested_plot <- herb_temp_nested_mod %>% mutate(plot = map(model, get_graph))
herb_temp_graph <- plot_multi_graphs(nested_df = herb_temp_nested_plot, n_graphs = 3)

# Connectance 
(herb_temp_connect <- tibble(connectance = unlist(herb_temp_nested_mod$connectance)) %>% 
    add_column(network = factor(c("low", "medium", "high"))) %>% 
    select(network, connectance))

# MPAs --------------------------------------------------------------------
# without depth
herb_mpa_cat_nested <- nested_data(categorised_data = as.data.frame(herb_mpa))
herb_mpa_cat_model <- get_model(data = herb_mpa, ncov = 1)
herb_mpa_nested_mod <- nested_models(nested_df = herb_mpa_cat_nested)
herb_mpa_nested_plot <- herb_mpa_nested_mod %>% mutate(plot = map(model, get_graph))
herb_mpa_graph <- plot_multi_graphs(nested_df = herb_mpa_nested_plot, n_graphs = 2)

# Connectance 
(herb_mpa_connect <- tibble(connectance = unlist(herb_mpa_nested_mod$connectance)) %>% 
  add_column(network = factor(c("outside MPA", "inside MPA"))) %>% 
  select(network, connectance))


## Stationarity -----------------------------------------------------------
# Relative importance
herb_temp_relimp <- sapply(X = herb_temp_dep_model$mod$key_coefs, rel_imp, cov = ("tmean_reg")) %>% 
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

herb_mpa_relimp <- sapply(X = herb_mpa_dep_model$mod$key_coefs, rel_imp, cov = "mpa") %>% 
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

(herb_relimp <- herb_temp_relimp %>%
  left_join(herb_mpa_relimp, by = "species"))

# Mean coefficients
herb_temp_meancoefs <- sapply(X = herb_temp_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

herb_mpa_meancoefs <- sapply(X = herb_mpa_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

herb_spp_meancoef <- herb_temp_meancoefs %>%
  left_join(herb_mpa_meancoefs, by = "species")

formattable(herb_spp_meancoef, align = c("l","c"), list(
  `species` = formatter("span", style = ~ style(color = "grey", font.weight = "bold")), 
  `temp_model` = col_formatter,
  `mpa_model` = col_formatter
))

```


In the whole Mediterranean we seen some associations but when not considering _Siganus rivulatus_ (according to the data it appears only in the eastern basin) - there are no other associations.  

Species relationships appear to be stationary in the groupers case and the seabreams case, but in the herbivores subset the raltionships were different when considering covariates. This was only relevant when the species from the eastern basin were considered.

# All species in all basins  

**Currently not running (MRFcov)**

```{r eval=FALSE, fig.align='center', warning=FALSE, include=FALSE}

all_spps <- med_raw %>% distinct(species)

## Create matrices --------------------------------------------------------
# Filter out species that appear less than 10 times in the dataset
full_med <- med_raw %>%
  group_by(lat, lon, site, trans, species, tmean_reg, mpa, depth_reg) %>%
  summarise(n = sum(sp.n)) %>% 
  filter(n > 10) %>% 
  spread(species, n, fill = 0) %>% 
  sample_n(size = 1) %>% 
  ungroup() %>% 
  na.omit() %>% 
  mutate(loc = paste(site, trans)) %>% 
  column_to_rownames("loc")

# And coordinate
full_coords <- med_raw %>%
  group_by(lat, lon, site, trans, species, tmean_reg, mpa, depth_reg) %>%
  summarise(n = sum(sp.n)) %>% 
  filter(n > 10) %>% 
  spread(species, n, fill = 0) %>% 
  sample_n(size = 1) %>% 
  ungroup() %>% 
  na.omit() %>% 
  mutate(loc = paste(site, trans)) %>% 
  column_to_rownames("loc") %>% 
  select(lat, lon)

# Temperature and depth ---------------------------------------------------
full_temp_dep <- full_med %>% 
  select(8:ncol(.), tmean_reg, depth_reg) %>% 
  as.matrix()

# Temperature -------------------------------------------------------------
full_temp <- full_med %>% 
  select(8:ncol(.), tmean_reg) %>% 
  as.matrix()

# MPAs and depth ----------------------------------------------------------
full_mpa_dep <- full_med %>% 
  select(8:ncol(.), mpa, depth_reg) %>% 
  as.matrix()

# MPAs --------------------------------------------------------------------
full_mpa <- full_med %>% 
  select(8:ncol(.), mpa) %>% 
  as.matrix()

## Run models -------------------------------------------------------------

# Temperature and depth ---------------------------------------------------

full_temp_dep_model <- run_mod(species = full_temp_dep, n_covs = 2,
                           family = "gaussian", coords = full_coords)
plotMRF_hm(full_temp_dep_model$mod, main = "Species and temperature (incl. depth) - association coefficients")

# MPAs and depth ----------------------------------------------------------

full_mpa_dep_model <- run_mod(species = full_mpa_dep, n_covs = 2,
                          family = "gaussian", coords = full_coords)
plotMRF_hm(full_mpa_dep_model$mod, main = "Species and MPAs (incl. depth) - association coefficients")


## Networks ---------------------------------------------------------------

# Temperature -------------------------------------------------------------
# without depth
full_temp_cats <- categorise_cov(species = full_temp, covariate = "tmean_reg")
full_temp_cat_nested <- nested_data(categorised_data = full_temp_cats)
full_temp_cat_model <- get_model(data = full_temp, ncov = 1)
full_temp_nested_mod <- nested_models(nested_df = full_temp_cat_nested)
full_temp_nested_plot <- full_temp_nested_mod %>% mutate(plot = map(model, get_graph))
full_temp_graph <- plot_multi_graphs(nested_df = full_temp_nested_plot, n_graphs = 3)

# Connectance 
(full_temp_connect <- tibble(connectance = unlist(full_temp_nested_mod$connectance)) %>% 
    add_column(network = factor(c("low", "medium", "high"))) %>% 
    select(network, connectance))

# MPAs --------------------------------------------------------------------
# without depth
full_mpa_cat_nested <- nested_data(categorised_data = as.data.frame(full_mpa))
full_mpa_cat_model <- get_model(data = full_mpa, ncov = 1)
full_mpa_nested_mod <- nested_models(nested_df = full_mpa_cat_nested)
full_mpa_nested_plot <- full_mpa_nested_mod %>% mutate(plot = map(model, get_graph))
full_mpa_graph <- plot_multi_graphs(nested_df = full_mpa_nested_plot, n_graphs = 2)

# Connectance 
(full_mpa_connect <- tibble(connectance = unlist(full_mpa_nested_mod$connectance)) %>% 
  add_column(network = factor(c("outside MPA", "inside MPA"))) %>% 
  select(network, connectance))


## Stationarity -----------------------------------------------------------
# Relative importance
full_temp_relimp <- sapply(X = full_temp_dep_model$mod$key_coefs, rel_imp, cov = ("tmean_reg")) %>% 
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

full_mpa_relimp <- sapply(X = full_mpa_dep_model$mod$key_coefs, rel_imp, cov = "mpa") %>% 
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

(full_relimp <- full_temp_relimp %>%
  left_join(full_mpa_relimp, by = "species"))

# Mean coefficients
full_temp_meancoefs <- sapply(X = full_temp_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

full_mpa_meancoefs <- sapply(X = full_mpa_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

full_spp_meancoef <- full_temp_meancoefs %>%
  left_join(full_mpa_meancoefs, by = "species")

formattable(full_spp_meancoef, align = c("l","c"), list(
  `species` = formatter("span", style = ~ style(color = "grey", font.weight = "bold")), 
  `temp_model` = col_formatter,
  `mpa_model` = col_formatter
))

```


# Data exploration

The depth factor is a bit problematic because the samples are not distributed evenly between depths and spatialy:  
```{r echo=FALSE}
ggplot(med_raw, aes(depth)) + geom_histogram(binwidth = 1, aes(fill = ..x..)) +
  labs(x = "Depth of transect", y = "Frequency", title = "Depth") +
  guides(fill = FALSE)

```

The problem is mainly with Sala's data:
```{r message=FALSE, warning=FALSE}

grps_depth <- med_raw %>% filter(species == groupers)
ggplot(grps_depth) +
  geom_histogram(aes(x = depth, fill = data.origin), binwidth = 1) +
  ggtitle("Groupers depth distribution")

dip_depth <- med_raw %>% filter(species == diplodus)
ggplot(dip_depth) +
  geom_histogram(aes(x = depth, fill = data.origin), binwidth = 1) +
  ggtitle("Seabreams depth distribution")

rm(list = c("grps_depth", "dip_depth"))

```


___

[^1]: Clark, Nicholas J., Konstans Wells, and Oscar Lindberg. "Unravelling changing interspecific interactions across environmental gradients using Markov random fields." Ecology 99.6 (2018): 1277-1283.

[^2]: Delmas, E., Besson, M., Brice, M. H., Burkle, L. A., Dalla Riva, G. V., Fortin, M. J., ... & Olesen, J. M. (2019). Analysing ecological networks of species interactions. Biological Reviews, 94(1), 16-36.

