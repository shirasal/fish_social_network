---
title: "Results"
author: "Shira Salingre"
output: 
  html_document:
    theme: united
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
---

```{r setup, include=FALSE}
source("scripts/pckgs_preps.R")
source("scripts/model_func.R")
library(usethis)

```

In order to examine the association between species and how this association changes along environmental gradient, I chose three groups of representative fish species: groupers (Epinephelus species + Serranus species), Seabream species and herbivore species.  

I'm using the MRF-based model from `MRFcov` package (Clark _et al._ [^1]) to detemine the level and direction of species association in each group.  

MPAs are defined as unprotected (enforcement level 0-1) or protected (2-3); therefore this is not a gradient.  
<!--Does this affect the model?-->

Connectance (Delams _et al._ [^2]) is a measure of comparison between networks. Essentially, it describes the level of connectedness of species in the network as a proportion the potential associations in the network:

    C0 = [total # of edges] / [total # of nodes^2 (total possible connections)]

L = number of edges (associations)  
S = number of nodes (species)  
M = S^2  
connectance (C0) = L/M  


# Groupers
```{r warning=FALSE, fig.align='center'}

## Create matrices --------------------------------------------------------
# Temperature and depth ---------------------------------------------------
grps_temp_dep <- create_spp_mat(dataset = med_raw, basin = all_med,
                                group = groupers, covariate = c("tmean_reg", "depth_reg"))
grps_temp_dep_mat <- grps_temp_dep[[1]]
grps_temp_dep_coords <- grps_temp_dep[[2]]
rm(grps_temp_dep)
# Temperature -------------------------------------------------------------
grps_temp <- create_spp_mat(dataset = med_raw, basin = all_med,
                            group = groupers, covariate = "tmean_reg")
grps_temp_mat <- grps_temp[[1]]
grps_temp_coords <- grps_temp[[2]]
rm(grps_temp)
# MPAs and depth ----------------------------------------------------------
grps_mpa_dep <- create_spp_mat(dataset = med_raw, basin = all_med,
                               group = groupers, covariate = c("mpa", "depth_reg"))
grps_mpa_dep_mat <- grps_mpa_dep[[1]]
grps_mpa_dep_coords <- grps_mpa_dep[[2]]
rm(grps_mpa)
# MPAs --------------------------------------------------------------------
grps_mpa <- create_spp_mat(dataset = med_raw, basin = all_med,
                           group = groupers, covariate = "mpa")
grps_mpa_mat <- grps_mpa[[1]]
grps_mpa_coords <- grps_mpa[[2]]
rm(grps_mpa)

## Run models -------------------------------------------------------------

# Temperature and depth ---------------------------------------------------

grps_temp_dep_model <- run_mod(species_mat = grps_temp_dep_mat, n_covs = 2,
                           family = "gaussian", coords = grps_temp_dep_coords)
plotMRF_hm(grps_temp_dep_model$mod, main = "Groupers and temperature (incl. depth) - association coefficients")

# MPAs and depth ----------------------------------------------------------

grps_mpa_dep_model <- run_mod(species_mat = grps_mpa_dep_mat, n_covs = 2,
                          family = "gaussian", coords = grps_mpa_dep_coords)
plotMRF_hm(grps_mpa_dep_model$mod, main = "Groupers and MPAs (incl. depth) - association coefficients")


## Networks ---------------------------------------------------------------

# Temperature -------------------------------------------------------------
# without depth
grps_temp_cats <- categorise_cov(species_mat = grps_temp_mat, covariate = "tmean_reg")
grps_temp_cat_nested <- nested_data(categorised_data = grps_temp_cats)
grps_temp_cat_model <- get_model(data = grps_temp_mat, ncov = 1)
grps_temp_nested_mod <- nested_models(nested_df = grps_temp_cat_nested)
grps_temp_nested_plot <- grps_temp_nested_mod %>% mutate(plot = map(model, get_graph))
grps_temp_graph <- plot_multi_graphs(nested_df = grps_temp_nested_plot, n_graphs = 3)

# Connectance 
(grps_temp_connect <- tibble(connectance = unlist(grps_temp_nested_mod$connectance)) %>% 
    add_column(network = factor(c("low", "medium", "high"))) %>% 
    select(network, connectance))

# MPAs --------------------------------------------------------------------
# without depth
grps_mpa_cat_nested <- nested_data(categorised_data = as.data.frame(grps_mpa_mat))
grps_mpa_cat_model <- get_model(data = grps_mpa_mat, ncov = 1)
grps_mpa_nested_mod <- nested_models(nested_df = grps_mpa_cat_nested)
grps_mpa_nested_plot <- grps_mpa_nested_mod %>% mutate(plot = map(model, get_graph))
grps_mpa_graph <- plot_multi_graphs(nested_df = grps_mpa_nested_plot, n_graphs = 2)

# Connectance 
(grps_mpa_connect <- tibble(connectance = unlist(grps_mpa_nested_mod$connectance)) %>% 
  add_column(network = factor(c("outside MPA", "inside MPA"))) %>% 
  select(network, connectance))


## Stationarity -----------------------------------------------------------
# Relative importance
grps_temp_relimp <- sapply(X = grps_temp_dep_model$mod$key_coefs, rel_imp, cov = ("tmean_reg")) %>% 
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

grps_mpa_relimp <- sapply(X = grps_mpa_dep_model$mod$key_coefs, rel_imp, cov = "mpa") %>% 
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

(grps_relimp <- grps_temp_relimp %>%
  left_join(grps_mpa_relimp, by = "species"))

# Mean coefficients
grps_temp_meancoefs <- sapply(X = grps_temp_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

grps_mpa_meancoefs <- sapply(X = grps_mpa_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

(grps_spp_meancoef <- grps_temp_meancoefs %>%
  left_join(grps_mpa_meancoefs, by = "species"))
```

Most grouper species are affected mainly by other species occurrence rather than covatiates (temperature, MPAs and depth).  
_Mycteroperca rubra_ shows a different pattern whereas temperature and MPAs are stronger factors than biotic interactions.  

# Seabreams
```{r warning=FALSE, fig.align='center'}

## Create matrices --------------------------------------------------------
# Temperature and depth ---------------------------------------------------
dip_temp_dep <- create_spp_mat(dataset = med_raw, basin = all_med,
                                group = diplodus, covariate = c("tmean_reg", "depth_reg"))
dip_temp_dep_mat <- dip_temp_dep[[1]]
dip_temp_dep_coords <- dip_temp_dep[[2]]
rm(dip_temp_dep)
# Temperature -------------------------------------------------------------
dip_temp <- create_spp_mat(dataset = med_raw, basin = all_med,
                            group = diplodus, covariate = "tmean_reg")
dip_temp_mat <- dip_temp[[1]]
dip_temp_coords <- dip_temp[[2]]
rm(dip_temp)
# MPAs and depth ----------------------------------------------------------
dip_mpa_dep <- create_spp_mat(dataset = med_raw, basin = all_med,
                               group = diplodus, covariate = c("mpa", "depth_reg"))
dip_mpa_dep_mat <- dip_mpa_dep[[1]]
dip_mpa_dep_coords <- dip_mpa_dep[[2]]
rm(dip_mpa)
# MPAs --------------------------------------------------------------------
dip_mpa <- create_spp_mat(dataset = med_raw, basin = all_med,
                           group = diplodus, covariate = "mpa")
dip_mpa_mat <- dip_mpa[[1]]
dip_mpa_coords <- dip_mpa[[2]]
rm(dip_mpa)

## Run models -------------------------------------------------------------

# Temperature and depth ---------------------------------------------------

dip_temp_dep_model <- run_mod(species_mat = dip_temp_dep_mat, n_covs = 2,
                           family = "gaussian", coords = dip_temp_dep_coords)
plotMRF_hm(dip_temp_dep_model$mod, main = "Seabreams and temperature (incl. depth) - association coefficients")

# MPAs and depth ----------------------------------------------------------

dip_mpa_dep_model <- run_mod(species_mat = dip_mpa_dep_mat, n_covs = 2,
                          family = "gaussian", coords = dip_mpa_dep_coords)
plotMRF_hm(dip_mpa_dep_model$mod, main = "Seabreams and MPAs (incl. depth) - association coefficients")


## Networks ---------------------------------------------------------------

# Temperature -------------------------------------------------------------
# without depth
dip_temp_cats <- categorise_cov(species_mat = dip_temp_mat, covariate = "tmean_reg")
dip_temp_cat_nested <- nested_data(categorised_data = dip_temp_cats)
dip_temp_cat_model <- get_model(data = dip_temp_mat, ncov = 1)
dip_temp_nested_mod <- nested_models(nested_df = dip_temp_cat_nested)
dip_temp_nested_plot <- dip_temp_nested_mod %>% mutate(plot = map(model, get_graph))
dip_temp_graph <- plot_multi_graphs(nested_df = dip_temp_nested_plot, n_graphs = 3)

# Connectance 
(dip_temp_connect <- tibble(connectance = unlist(dip_temp_nested_mod$connectance)) %>% 
    add_column(network = factor(c("low", "medium", "high"))) %>% 
    select(network, connectance))

# MPAs --------------------------------------------------------------------
# without depth
dip_mpa_cat_nested <- nested_data(categorised_data = as.data.frame(dip_mpa_mat))
dip_mpa_cat_model <- get_model(data = dip_mpa_mat, ncov = 1)
dip_mpa_nested_mod <- nested_models(nested_df = dip_mpa_cat_nested)
dip_mpa_nested_plot <- dip_mpa_nested_mod %>% mutate(plot = map(model, get_graph))
dip_mpa_graph <- plot_multi_graphs(nested_df = dip_mpa_nested_plot, n_graphs = 2)

# Connectance 
(dip_mpa_connect <- tibble(connectance = unlist(dip_mpa_nested_mod$connectance)) %>% 
  add_column(network = factor(c("outside MPA", "inside MPA"))) %>% 
  select(network, connectance))


## Stationarity -----------------------------------------------------------
# Relative importance
dip_temp_relimp <- sapply(X = dip_temp_dep_model$mod$key_coefs, rel_imp, cov = ("tmean_reg")) %>% 
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

dip_mpa_relimp <- sapply(X = dip_mpa_dep_model$mod$key_coefs, rel_imp, cov = "mpa") %>% 
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

(dip_relimp <- dip_temp_relimp %>%
  left_join(dip_mpa_relimp, by = "species"))

# Mean coefficients
dip_temp_meancoefs <- sapply(X = dip_temp_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

dip_mpa_meancoefs <- sapply(X = dip_mpa_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

(dip_spp_meancoef <- dip_temp_meancoefs %>%
  left_join(dip_mpa_meancoefs, by = "species"))

```

Seabream species are not greatly affected by other species accept _Diplodus cervinus_, which seem to show a different pattern with temperature and depth effects.


# Herbivores in western basin
```{r warning=FALSE, fig.align='center'}
herb_west <- c("Sparisoma.cretense", "Sarpa.salpa", "Siganus.luridus")

## Create matrices --------------------------------------------------------
# Temperature and depth ---------------------------------------------------
herb_west_temp_dep <- create_spp_mat(dataset = med_raw, basin = west,
                                group = herb_west, covariate = c("tmean_reg", "depth_reg"))
herb_west_temp_dep_mat <- herb_west_temp_dep[[1]]
herb_west_temp_dep_coords <- herb_west_temp_dep[[2]]
rm(herb_west_temp_dep)
# Temperature -------------------------------------------------------------
herb_west_temp <- create_spp_mat(dataset = med_raw, basin = west,
                            group = herb_west, covariate = "tmean_reg")
herb_west_temp_mat <- herb_west_temp[[1]]
herb_west_temp_coords <- herb_west_temp[[2]]
rm(herb_west_temp)
# MPAs and depth ----------------------------------------------------------
herb_west_mpa_dep <- create_spp_mat(dataset = med_raw, basin = west,
                               group = herb_west, covariate = c("mpa", "depth_reg"))
herb_west_mpa_dep_mat <- herb_west_mpa_dep[[1]]
herb_west_mpa_dep_coords <- herb_west_mpa_dep[[2]]
rm(herb_west_mpa)
# MPAs --------------------------------------------------------------------
herb_west_mpa <- create_spp_mat(dataset = med_raw, basin = west,
                           group = herb_west, covariate = "mpa")
herb_west_mpa_mat <- herb_west_mpa[[1]]
herb_west_mpa_coords <- herb_west_mpa[[2]]
rm(herb_west_mpa)

## Run models -------------------------------------------------------------

# Temperature and depth ---------------------------------------------------

herb_west_temp_dep_model <- run_mod(species_mat = herb_west_temp_dep_mat, n_covs = 2,
                           family = "gaussian", coords = herb_west_temp_dep_coords)
plotMRF_hm(herb_west_temp_dep_model$mod, main = "Herbivores and temperature (incl. depth) in the west - association coefficients")

# MPAs and depth ----------------------------------------------------------

herb_west_mpa_dep_model <- run_mod(species_mat = herb_west_mpa_dep_mat, n_covs = 2,
                          family = "gaussian", coords = herb_west_mpa_dep_coords)
plotMRF_hm(herb_west_mpa_dep_model$mod, main = "Herbivores and MPAs (incl. depth) in the west - association coefficients")


## Networks ---------------------------------------------------------------

# Temperature -------------------------------------------------------------
# without depth
herb_west_temp_cats <- categorise_cov(species_mat = herb_west_temp_mat, covariate = "tmean_reg")
herb_west_temp_cat_nested <- nested_data(categorised_data = herb_west_temp_cats)
herb_west_temp_cat_model <- get_model(data = herb_west_temp_mat, ncov = 1)
herb_west_temp_nested_mod <- nested_models(nested_df = herb_west_temp_cat_nested)
herb_west_temp_nested_plot <- herb_west_temp_nested_mod %>% mutate(plot = map(model, get_graph))
# herb_west_temp_graph <- plot_multi_graphs(nested_df = herb_west_temp_nested_plot, n_graphs = 3)
ui_oops("Problem with igraph here :(")

# Connectance 
(herb_west_temp_connect <- tibble(connectance = unlist(herb_west_temp_nested_mod$connectance)) %>% 
    add_column(network = factor(c("low", "medium", "high"))) %>% 
    select(network, connectance))

# MPAs --------------------------------------------------------------------
# without depth
herb_west_mpa_cat_nested <- nested_data(categorised_data = as.data.frame(herb_west_mpa_mat))
herb_west_mpa_cat_model <- get_model(data = herb_west_mpa_mat, ncov = 1)
herb_west_mpa_nested_mod <- nested_models(nested_df = herb_west_mpa_cat_nested)
herb_west_mpa_nested_plot <- herb_west_mpa_nested_mod %>% mutate(plot = map(model, get_graph))
# herb_west_mpa_graph <- plot_multi_graphs(nested_df = herb_west_mpa_nested_plot, n_graphs = 2)
ui_oops("Problem with igraph here :(")

# Connectance 
(herb_west_mpa_connect <- tibble(connectance = unlist(herb_west_mpa_nested_mod$connectance)) %>% 
  add_column(network = factor(c("outside MPA", "inside MPA"))) %>% 
  select(network, connectance))


## Stationarity -----------------------------------------------------------
# Relative importance
herb_west_temp_relimp <- sapply(X = herb_west_temp_dep_model$mod$key_coefs, rel_imp, cov = ("tmean_reg")) %>% 
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

herb_west_mpa_relimp <- sapply(X = herb_west_mpa_dep_model$mod$key_coefs, rel_imp, cov = "mpa") %>% 
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

(herb_west_relimp <- herb_west_temp_relimp %>%
  left_join(herb_west_mpa_relimp, by = "species"))

# Mean coefficients
herb_west_temp_meancoefs <- sapply(X = herb_west_temp_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

herb_west_mpa_meancoefs <- sapply(X = herb_west_mpa_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

(herb_west_spp_meancoef <- herb_west_temp_meancoefs %>%
  left_join(herb_west_mpa_meancoefs, by = "species"))

```

# Herbivores in both basins  
```{r warning=FALSE, fig.align='center'}

## Create matrices --------------------------------------------------------
# Temperature and depth ---------------------------------------------------
herb_temp_dep <- create_spp_mat(dataset = med_raw, basin = all_med,
                                group = herbivores, covariate = c("tmean_reg", "depth_reg"))
herb_temp_dep_mat <- herb_temp_dep[[1]]
herb_temp_dep_coords <- herb_temp_dep[[2]]
rm(herb_temp_dep)
# Temperature -------------------------------------------------------------
herb_temp <- create_spp_mat(dataset = med_raw, basin = all_med,
                            group = herbivores, covariate = "tmean_reg")
herb_temp_mat <- herb_temp[[1]]
herb_temp_coords <- herb_temp[[2]]
rm(herb_temp)
# MPAs and depth ----------------------------------------------------------
herb_mpa_dep <- create_spp_mat(dataset = med_raw, basin = all_med,
                               group = herbivores, covariate = c("mpa", "depth_reg"))
herb_mpa_dep_mat <- herb_mpa_dep[[1]]
herb_mpa_dep_coords <- herb_mpa_dep[[2]]
rm(herb_mpa)
# MPAs --------------------------------------------------------------------
herb_mpa <- create_spp_mat(dataset = med_raw, basin = all_med,
                           group = herbivores, covariate = "mpa")
herb_mpa_mat <- herb_mpa[[1]]
herb_mpa_coords <- herb_mpa[[2]]
rm(herb_mpa)

## Run models -------------------------------------------------------------

# Temperature and depth ---------------------------------------------------

herb_temp_dep_model <- run_mod(species_mat = herb_temp_dep_mat, n_covs = 2,
                           family = "gaussian", coords = herb_temp_dep_coords)
plotMRF_hm(herb_temp_dep_model$mod, main = "Herbivores and temperature (incl. depth) - association coefficients")

# MPAs and depth ----------------------------------------------------------

herb_mpa_dep_model <- run_mod(species_mat = herb_mpa_dep_mat, n_covs = 2,
                          family = "gaussian", coords = herb_mpa_dep_coords)
plotMRF_hm(herb_mpa_dep_model$mod, main = "Herbivores and MPAs (incl. depth) - association coefficients")


## Networks ---------------------------------------------------------------

# Temperature -------------------------------------------------------------
# without depth
herb_temp_cats <- categorise_cov(species_mat = herb_temp_mat, covariate = "tmean_reg")
herb_temp_cat_nested <- nested_data(categorised_data = herb_temp_cats)
herb_temp_cat_model <- get_model(data = herb_temp_mat, ncov = 1)
herb_temp_nested_mod <- nested_models(nested_df = herb_temp_cat_nested)
herb_temp_nested_plot <- herb_temp_nested_mod %>% mutate(plot = map(model, get_graph))
herb_temp_graph <- plot_multi_graphs(nested_df = herb_temp_nested_plot, n_graphs = 3)

# Connectance 
(herb_temp_connect <- tibble(connectance = unlist(herb_temp_nested_mod$connectance)) %>% 
    add_column(network = factor(c("low", "medium", "high"))) %>% 
    select(network, connectance))

# MPAs --------------------------------------------------------------------
# without depth
herb_mpa_cat_nested <- nested_data(categorised_data = as.data.frame(herb_mpa_mat))
herb_mpa_cat_model <- get_model(data = herb_mpa_mat, ncov = 1)
herb_mpa_nested_mod <- nested_models(nested_df = herb_mpa_cat_nested)
herb_mpa_nested_plot <- herb_mpa_nested_mod %>% mutate(plot = map(model, get_graph))
herb_mpa_graph <- plot_multi_graphs(nested_df = herb_mpa_nested_plot, n_graphs = 2)

# Connectance 
(herb_mpa_connect <- tibble(connectance = unlist(herb_mpa_nested_mod$connectance)) %>% 
  add_column(network = factor(c("outside MPA", "inside MPA"))) %>% 
  select(network, connectance))


## Stationarity -----------------------------------------------------------
# Relative importance
herb_temp_relimp <- sapply(X = herb_temp_dep_model$mod$key_coefs, rel_imp, cov = ("tmean_reg")) %>% 
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

herb_mpa_relimp <- sapply(X = herb_mpa_dep_model$mod$key_coefs, rel_imp, cov = "mpa") %>% 
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

(herb_relimp <- herb_temp_relimp %>%
  left_join(herb_mpa_relimp, by = "species"))

# Mean coefficients
herb_temp_meancoefs <- sapply(X = herb_temp_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "temp_model" = value)

herb_mpa_meancoefs <- sapply(X = herb_mpa_dep_model$mod$key_coefs, FUN = mean_coef) %>%
  tibble::enframe() %>% 
  rename("species" = name, "mpa_model" = value)

(herb_spp_meancoef <- herb_temp_meancoefs %>%
  left_join(herb_mpa_meancoefs, by = "species"))

```


In the whole Mediterranean we seen some associations but when not considering _Siganus rivulatus_ (according to the data it appears only in the eastern basin) - there are no other associations.  


The depth factor is a bit problematic because the samples are not distributed evenly between depths and spatialy:  
```{r echo=FALSE}
ggplot(med_raw, aes(depth)) + geom_histogram(binwidth = 1, aes(fill = ..x..)) +
  labs(x = "Depth of transect", y = "Frequency", title = "Depth") +
  guides(fill = FALSE)

```

The problem is mainly with Sala's data:
```{r message=FALSE, warning=FALSE}

grps_depth <- med_raw %>% filter(species == groupers)
ggplot(grps_depth) +
  geom_histogram(aes(x = depth, fill = data.origin), binwidth = 1) +
  ggtitle("Groupers depth distribution")

dip_depth <- med_raw %>% filter(species == diplodus)
ggplot(dip_depth) +
  geom_histogram(aes(x = depth, fill = data.origin), binwidth = 1) +
  ggtitle("Seabreams depth distribution")

rm(list = c("grps_depth", "dip_depth"))

```


___

[^1]: Clark, Nicholas J., Konstans Wells, and Oscar Lindberg. "Unravelling changing interspecific interactions across environmental gradients using Markov random fields." Ecology 99.6 (2018): 1277-1283.

[^2]: Delmas, E., Besson, M., Brice, M. H., Burkle, L. A., Dalla Riva, G. V., Fortin, M. J., ... & Olesen, J. M. (2019). Analysing ecological networks of species interactions. Biological Reviews, 94(1), 16-36.

