---
title: "Results"
output: html_notebook
---

**How fish communities change along environmental gradients?**
Species associations are represented graphically and quantitatively using *MRFcov package* [^1].

```{r Load packages and functions, message=FALSE, warning=FALSE, include=FALSE}

source("scripts/pckgs_preps.R")
source("scripts/model_func.R")

```

### Data

```{r}

med_raw <- read_csv("data/med_raw.csv", col_types = cols(depth = "d")) %>%
  filter(data.origin != "azz_asi") %>% # remove presence-absence data
  mutate(loc = paste0(site, "_", trans), tmean_reg = scale(tmean), depth_reg = scale(depth))
str(med_raw)

```

### Define variables `basin`; `group`

```{r}
# Basins
west <- list("France", "Italy", "Spain")
east <- list("Croatia", "Greece", "Israel", "Malta", "Turkey")

# Groups
groupers <- c("Epinephelus.costae", "Epinephelus.marginatus",
              "Mycteroperca.rubra", "Serranus.cabrilla", "Serranus.scriba")
diplodus <- c("Diplodus.annularis", "Diplodus.puntazzo", "Diplodus.sargus",
              "Diplodus.vulgaris", "Diplodus.cervinus")
herbivores <- c("Siganus.rivulatus", "Siganus.luridus", "Sarpa.salpa",
                "Scarus.ghobban", "Sparisoma.cretense")

```

# Groupers

## Eastern Mediterranean

### Temperature as covariate

```{r}
# Create species matrix for `group` in `basin` with `covariate`
spp_mat <- create_spp_mat(dataset = med_raw, basin = east,
                          group = groupers, covariate = "tmean_reg")
str(spp_mat)

# Run model and create occurrence predictions
model_temp <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_temp <- model_temp$mod$direct_coefs
key_coef_temp <- model_temp$boot$mean_key_coefs
predict_temp <- model_temp$pred

# Categorise continuous data + Nest categorical (nominal) data
categories <- categorise_cov(species_mat = spp_mat, covariate = "tmean_reg")
nested_cats <- nested_data(categorised_data = categories)

# Run MRFcov model with some defaults
cat_model <- get_model(data = spp_mat, ncov = 1)
cat_model

# Run model on each category
nested <- nested_models(nested_df = nested_cats)

# Get graph data
nested_plot <- nested %>% mutate(plot = map(model, get_graph))

# Plot multiple graphs for gradient
temperature_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 3)

# png("figures/groupers_east_temp.png", height = 450, width = 1200, res = 150)
# plot_multi_graphs(nested_df = nested_plot, n_graphs = 3)
# dev.off()

```

### MPA as covariate
```{r}

spp_mat <- create_spp_mat(dataset = med_raw, basin = east,
                          group = groupers, covariate = "enforcement")

model_enf <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_enf <- model_enf$mod$direct_coefs
key_coef_enf <- model_enf$boot$mean_key_coefs
predict_enf <- model_enf$pred

# Func 3b (no need for 3a because it's already categorised) - nesting only
nested_cats <- nested_data(categorised_data = spp_mat)

cat_model <- get_model(data = spp_mat, ncov = 1)

nested <- nested_models(nested_df = nested_cats)

nested_plot <- nested %>% mutate(plot = map(model, get_graph))

MPAs_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 4) 

# png("figures/groupers_east_mpa.png", height = 450, width = 1600, res = 150)
# plot_multi_graphs(nested_df = nested_plot, n_graphs = 4)
# dev.off()

```

### Depth as covariate

```{r}
spp_mat <- create_spp_mat(dataset = med_raw, basin = east,
                          group = groupers, covariate = "depth_reg") %>% na.omit()

model_dep <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_dep <- model_dep$mod$direct_coefs
key_coef_dep <- model_dep$boot$mean_key_coefs
predict_dep <- model_dep$pred

categories <- categorise_cov(species_mat = spp_mat, covariate = "depth_reg")
nested_cats <- nested_data(categorised_data = categories)

cat_model <- get_model(data = spp_mat, ncov = 1)

nested <- nested_models(nested_df = nested_cats)

nested_plot <- nested %>% mutate(plot = map(model, get_graph))

depth_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 3)

# png("figures/groupers_east_depth.png", height = 450, width = 1200, res = 150)
# plot_multi_graphs(nested_df = nested_plot, n_graphs = 3)
# dev.off()

```



## Western Mediterranean

### Temperature as covariate

```{r}
# Create species matrix for `group` in `basin` with `covariate`
spp_mat <- create_spp_mat(dataset = med_raw, basin = west,
                          group = groupers, covariate = "tmean_reg")
str(spp_mat)

# Run model and create occurrence predictions
model_temp <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_temp <- model_temp$mod$direct_coefs
key_coef_temp <- model_temp$boot$mean_key_coefs
predict_temp <- model_temp$pred

# Categorise continuous data + Nest categorical (nominal) data
categories <- categorise_cov(species_mat = spp_mat, covariate = "tmean_reg")
nested_cats <- nested_data(categorised_data = categories)

# Run MRFcov model with some defaults
cat_model <- get_model(data = spp_mat, ncov = 1)

# Run model on each category
nested <- nested_models(nested_df = nested_cats)

# Get graph data
nested_plot <- nested %>% mutate(plot = map(model, get_graph))

# Plot multiple graphs for gradient
temperature_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 3)

```

### MPA as covariate
```{r}

spp_mat <- create_spp_mat(dataset = med_raw, basin = east,
                          group = groupers, covariate = "enforcement")

model_enf <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_enf <- model_enf$mod$direct_coefs
key_coef_enf <- model_enf$boot$mean_key_coefs
predict_enf <- model_enf$pred

# Func 3b (no need for 3a because it's already categorised) - nesting only
nested_cats <- nested_data(categorised_data = spp_mat)

cat_model <- get_model(data = spp_mat, ncov = 1)

nested <- nested_models(nested_df = nested_cats)

nested_plot <- nested %>% mutate(plot = map(model, get_graph))

MPAs_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 4) 

```

### Depth as covariate

```{r}
spp_mat <- create_spp_mat(dataset = med_raw, basin = east,
                          group = groupers, covariate = "depth_reg") %>% na.omit()

model_dep <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_dep <- model_dep$mod$direct_coefs
key_coef_dep <- model_dep$boot$mean_key_coefs
predict_dep <- model_dep$pred

categories <- categorise_cov(species_mat = spp_mat, covariate = "depth_reg")
nested_cats <- nested_data(categorised_data = categories)

cat_model <- get_model(data = spp_mat, ncov = 1)

nested <- nested_models(nested_df = nested_cats)

nested_plot <- nested %>% mutate(plot = map(model, get_graph))

depth_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 3)

```

# Diplodus

## Eastern Mediterranean

### Temperature as covariate

```{r}
spp_mat <- create_spp_mat(dataset = med_raw, basin = east,
                          group = diplodus, covariate = "tmean_reg")

model_temp <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_temp <- model_temp$mod$direct_coefs
key_coef_temp <- model_temp$boot$mean_key_coefs
predict_temp <- model_temp$pred

categories <- categorise_cov(species_mat = spp_mat, covariate = "tmean_reg")
nested_cats <- nested_data(categorised_data = categories)

cat_model <- get_model(data = spp_mat, ncov = 1)

nested <- nested_models(nested_df = nested_cats)

nested_plot <- nested %>% mutate(plot = map(model, get_graph))

temperature_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 3)

# FIXME problem with the first graph element


```

### MPA as covariate
```{r}

spp_mat <- create_spp_mat(dataset = med_raw, basin = east,
                          group = diplodus, covariate = "enforcement")

model_enf <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_enf <- model_enf$mod$direct_coefs
key_coef_enf <- model_enf$boot$mean_key_coefs
predict_enf <- model_enf$pred

nested_cats <- nested_data(categorised_data = spp_mat)

cat_model <- get_model(data = spp_mat, ncov = 1)

nested <- nested_models(nested_df = nested_cats)

nested_plot <- nested %>% mutate(plot = map(model, get_graph))

MPAs_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 4) 


```

### Depth as covariate

```{r}
spp_mat <- create_spp_mat(dataset = med_raw, basin = east,
                          group = diplodus, covariate = "depth_reg") %>% na.omit()

model_dep <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_dep <- model_dep$mod$direct_coefs
key_coef_dep <- model_dep$boot$mean_key_coefs
predict_dep <- model_dep$pred

categories <- categorise_cov(species_mat = spp_mat, covariate = "depth_reg")
nested_cats <- nested_data(categorised_data = categories)

cat_model <- get_model(data = spp_mat, ncov = 1)

nested <- nested_models(nested_df = nested_cats)

nested_plot <- nested %>% mutate(plot = map(model, get_graph))

depth_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 3)
# FIXME problem with the first graph element

png("figures/diplodus_east_depth.png", height = 450, width = 1200, res = 150)
plot_multi_graphs(nested_df = nested_plot, n_graphs = 3)
dev.off()

```



## Western Mediterranean

### Temperature as covariate

```{r}
spp_mat <- create_spp_mat(dataset = med_raw, basin = west,
                          group = diplodus, covariate = "tmean_reg")

model_temp <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_temp <- model_temp$mod$direct_coefs
key_coef_temp <- model_temp$boot$mean_key_coefs
predict_temp <- model_temp$pred

categories <- categorise_cov(species_mat = spp_mat, covariate = "tmean_reg")
nested_cats <- nested_data(categorised_data = categories)

cat_model <- get_model(data = spp_mat, ncov = 1)

nested <- nested_models(nested_df = nested_cats)

nested_plot <- nested %>% mutate(plot = map(model, get_graph))

temperature_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 3)

```

### MPA as covariate
```{r}

spp_mat <- create_spp_mat(dataset = med_raw, basin = west,
                          group = diplodus, covariate = "enforcement") %>% na.omit()

model_enf <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_enf <- model_enf$mod$direct_coefs
key_coef_enf <- model_enf$boot$mean_key_coefs
predict_enf <- model_enf$pred

nested_cats <- nested_data(categorised_data = spp_mat)

cat_model <- get_model(data = spp_mat, ncov = 1)

nested <- nested_models(nested_df = nested_cats)

nested_plot <- nested %>% mutate(plot = map(model, get_graph))

MPAs_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 4) 

```

### Depth as covariate

```{r}
spp_mat <- create_spp_mat(dataset = med_raw, basin = west,
                          group = diplodus, covariate = "depth_reg") %>% na.omit()

model_dep <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_dep <- model_dep$mod$direct_coefs
key_coef_dep <- model_dep$boot$mean_key_coefs
predict_dep <- model_dep$pred

categories <- categorise_cov(species_mat = spp_mat, covariate = "depth_reg") # BUG
nested_cats <- nested_data(categorised_data = categories)

cat_model <- get_model(data = spp_mat, ncov = 1)

nested <- nested_models(nested_df = nested_cats)

nested_plot <- nested %>% mutate(plot = map(model, get_graph))

depth_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 3)

png("figures/diplodus_west_depth.png", height = 450, width = 1200, res = 150)
plot_multi_graphs(nested_df = nested_plot, n_graphs = 3)
dev.off()

```
Depths range is too small for analysis 2-11 metres. and the data isn't distributed well enough between them.
Check it with:

```{r eval=FALSE, include=FALSE}
spp_mat$depth %>% table
```

# Herbivores

## Eastern Mediterranean

### Temperature as covariate

```{r}
spp_mat <- create_spp_mat(dataset = med_raw, basin = east,
                          group = herbivores, covariate = "tmean_reg")

model_temp <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_temp <- model_temp$mod$direct_coefs
key_coef_temp <- model_temp$boot$mean_key_coefs
predict_temp <- model_temp$pred

categories <- categorise_cov(species_mat = spp_mat, covariate = "tmean_reg")
nested_cats <- nested_data(categorised_data = categories)

cat_model <- get_model(data = spp_mat, ncov = 1)

nested <- nested_models(nested_df = nested_cats)

nested_plot <- nested %>% mutate(plot = map(model, get_graph))

temperature_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 3)

```

### MPA as covariate
```{r}

spp_mat <- create_spp_mat(dataset = med_raw, basin = east,
                          group = herbivores, covariate = "enforcement")

model_enf <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_enf <- model_enf$mod$direct_coefs
key_coef_enf <- model_enf$boot$mean_key_coefs
predict_enf <- model_enf$pred

nested_cats <- nested_data(categorised_data = spp_mat)

cat_model <- get_model(data = spp_mat, ncov = 1)

nested <- nested_models(nested_df = nested_cats)

nested_plot <- nested %>% mutate(plot = map(model, get_graph))

MPAs_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 4) 


```

### Depth as covariate

```{r}
spp_mat <- create_spp_mat(dataset = med_raw, basin = east,
                          group = herbivores, covariate = "depth_reg") %>% na.omit()

model_dep <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_dep <- model_dep$mod$direct_coefs
key_coef_dep <- model_dep$boot$mean_key_coefs
predict_dep <- model_dep$pred

categories <- categorise_cov(species_mat = spp_mat, covariate = "depth_reg")
nested_cats <- nested_data(categorised_data = categories)

cat_model <- get_model(data = spp_mat, ncov = 1)

nested <- nested_models(nested_df = nested_cats)

nested_plot <- nested %>% mutate(plot = map(model, get_graph))

depth_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 3)


```



## Western Mediterranean

The western basin doesn't have all the species of herbivores in the east so I'll make a new vector for them
```{r}

herb_west <- c("Siganus.luridus", "Sarpa.salpa", "Sparisoma.cretense")

```

### Temperature as covariate

```{r}
spp_mat <- create_spp_mat(dataset = med_raw, basin = west,
                          group = herb_west, covariate = "tmean_reg")

model_temp <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_temp <- model_temp$mod$direct_coefs
key_coef_temp <- model_temp$boot$mean_key_coefs
predict_temp <- model_temp$pred

categories <- categorise_cov(species_mat = spp_mat, covariate = "tmean_reg")
nested_cats <- nested_data(categorised_data = categories)

cat_model <- get_model(data = spp_mat, ncov = 1)

nested <- nested_models(nested_df = nested_cats)

nested_plot <- nested %>% mutate(plot = map(model, get_graph))

temperature_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 3)


```

### MPA as covariate
```{r}

spp_mat <- create_spp_mat(dataset = med_raw, basin = west,
                          group = herb_west, covariate = "enforcement") %>% na.omit()

model_enf <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_enf <- model_enf$mod$direct_coefs
key_coef_enf <- model_enf$boot$mean_key_coefs
predict_enf <- model_enf$pred

nested_cats <- nested_data(categorised_data = spp_mat)

cat_model <- get_model(data = spp_mat, ncov = 1)

nested <- nested_models(nested_df = nested_cats)

nested_plot <- nested %>% mutate(plot = map(model, get_graph))

MPAs_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 4) 
# FIXME Error in abs(E(sub_graph)$weight) : non-numeric argument to mathematical function

png("figures/herb_west_mpa.png", height = 450, width = 1600, res = 150)
plot_multi_graphs(nested_df = nested_plot, n_graphs = 4)
dev.off()

```

### Depth as covariate

```{r}
spp_mat <- create_spp_mat(dataset = med_raw, basin = west,
                          group = herb_west, covariate = "depth_reg") %>% na.omit()

model_dep <- run_mod(species_mat = spp_mat, n_covs = 1, family = "gaussian")
coef_dep <- model_dep$mod$direct_coefs
key_coef_dep <- model_dep$boot$mean_key_coefs
predict_dep <- model_dep$pred

categories <- categorise_cov(species_mat = spp_mat, covariate = "depth_reg")
# FIXME Error in cut(): breaks are not unique
nested_cats <- nested_data(categorised_data = categories)

cat_model <- get_model(data = spp_mat, ncov = 1)

nested <- nested_models(nested_df = nested_cats)

nested_plot <- nested %>% mutate(plot = map(model, get_graph))

depth_graph <- plot_multi_graphs(nested_df = nested_plot, n_graphs = 3)

png("figures/herb_west_depth.png", height = 450, width = 1200, res = 150)
plot_multi_graphs(nested_df = nested_plot, n_graphs = 3)
dev.off()

```
Again, a problem with the data distribution of depth data


# Data visualisations

## Covariates

### Temperature distribution
```{r}
hist(med_raw$tmean)

```

### Depth distribution
```{r}
hist(med_raw$depth)

```


___

[^1]: Clark, Nicholas J., Konstans Wells, and Oscar Lindberg. "Unravelling changing interspecific interactions across environmental gradients using Markov random fields." Ecology 99.6 (2018): 1277-1283.