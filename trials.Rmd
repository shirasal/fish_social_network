---
title: "Fish graphs"
output: html_notebook
---

```{r load packages, message=FALSE, include=FALSE}
library(MRFcov)
library(igraph)
library(tidyverse)

windowsFonts(Verdana = windowsFont("Verdana"))

```

Data has to have the following structure:
* rownames = sites
* colnames = species

## `MRFcov()` Markov Random Fields with covariates
This function is the workhorse of the MRFcov package, running separate penalized regressions for
each node to estimate parameters of Markov Random Fields (MRF) graphs. Covariates can be included
(a class of models known as Conditional Random Fields; CRF), to estimate how interactions
between nodes vary across covariate magnitudes.

```{r MRFcov Fish}
fish_samp_mat <- read.csv(file = "binary_matrix_proposal.csv", header = TRUE, row.names = 1) %>% 
  mutate_if(is.numeric, replace_na, replace = 0) %>% 
  mutate_if(is.numeric, ~1 * (. != 0)) %>% 
  as.matrix(.)
# write.table(fish_samp_mat, "fish sample matrix.csv", sep = ",", row.names = FALSE)

fish_mrf <- MRFcov(data = fish_samp_mat, n_nodes = 6, family = "gaussian") # symmetrise = mean

```

`symmetrise`: The method to use for symmetrising corresponding parameter estimates (which are taken from separate regressions). Options are min (take the coefficient with the smallest absolute value), max (take the coefficient with the largest absolute value) or mean (take the mean of the two coefficients). Default is mean.


## `plotMRF_hm` Plot MRF interaction parameters as a heatmap
This function uses outputs from fitted MRFcov and bootstrap_MRF models to plot a heatmap of node interaction coefficients.

```{r Co-occurrence matrix}
# png("co_occurrence.png")
plotMRF_hm(fish_mrf)
# dev.off()

```

## `predict_MRF` Predict training observations from fitted MRFcov models
This function calculates linear predictors for node observations using coefficients from an MRFcov or MRFcov_spatial object.

```{r Calculate linear predictors for species}
fish_predictors <- predict_MRF(data = fish_w_cov, MRF_mod = fish_cov_mrf, prep_covariates = TRUE)

```

Now let's explore relationships:

```{r GRAPH}
fish_network <- graph.adjacency(fish_mrf$graph, weighted = T, mode = "undirected")

# png("stationary_network.png")
plot.igraph(fish_network, layout = layout.circle(fish_network),
            edge.width = abs(E(fish_network)$weight),
            edge.color = ifelse(E(fish_network)$weight < 0,
                                'slateblue',
                                'darkred'),
            vertex.color = 'wheat',
            vertex.label.family = "Verdana",
            vertex.label.color = "azure4",
            vertex.label.dist = 2,
            vertex.label.cex = 1,
            label.degree = pi/4)
# dev.off()

```

These look so ugly!!! Here is how to change it (from ![R Graph Gallery](https://www.r-graph-gallery.com/248-igraph-plotting-parameters/))
```{r eval=FALSE, include=FALSE}
# Create data
set.seed(1)
g_data <- matrix(sample(0:1, 100, replace = TRUE, prob = c(0.8,0.2)), nc = 10)
g_network <- graph_from_adjacency_matrix(data, mode='undirected', diag = F)
 
# Default network
par(mar = c(0,0,0,0))
plot(g_network)

plot(g_network, 
    # === vertex
    vertex.color = rgb(0.8,0.4,0.3,0.8),  # Node color
    vertex.frame.color = "white",         # Node border color
    vertex.shape = "circle",              # One of “none”, “circle”, “square”, “csquare”, “rectangle” “crectangle”, “vrectangle”, “pie”, “raster”, or “sphere”
    vertex.size = 14,                     # Size of the node (default is 15)
    vertex.size2 = NA,                    # The second size of the node (e.g. for a rectangle)
    
    # === vertex label
    vertex.label = LETTERS[1:10],         # Character vector used to label the nodes
    vertex.label.color = "white",
    vertex.label.family = "Times",        # Font family of the label (e.g.“Times”, “Helvetica”)
    vertex.label.font = 2,                # Font: 1 plain, 2 bold, 3, italic, 4 bold italic, 5 symbol
    vertex.label.cex = 1,                 # Font size (multiplication factor, device-dependent)
    vertex.label.dist = 0,                # Distance between the label and the vertex
    vertex.label.degree = 0,              # The position of the label in relation to the vertex (use pi)
    
    # === Edge
    edge.color = "white",                 # Edge color
    edge.width = 4,                       # Edge width, defaults to 1
    edge.arrow.size = 1,                  # Arrow size, defaults to 1
    edge.arrow.width = 1,                 # Arrow width, defaults to 1
    edge.lty = "solid",                   # Line type, could be 0 or “blank”, 1 or “solid”, 2 or “dashed”, 3 or “dotted”, 4 or “dotdash”, 5 or “longdash”, 6 or “twodash”
    edge.curved = 0.3                     # Edge curvature, range 0-1 (FALSE sets it to 0, TRUE to 0.5)
    )

```

# Including covariates #
It is also highly advisable to scale any continuous variables so they all have mean = 0 and sd = 1 analysis (Clark's recommendation from `vignette(CRF_data_prep)`)

```{r MRFcov Fish with covariates, warning=FALSE}
max_temp <- read.csv(file = "max_temp_per_site.csv", header = TRUE)
fish_w_cov <- read.csv(file = "fish sample matrix.csv", header = TRUE)

fish_w_cov <- left_join(fish_w_cov, max_temp) 
rownames(fish_w_cov) <- fish_w_cov$site
fish_w_cov$site <- NULL
fish_w_cov$max_temp <- scale(fish_w_cov$max_temp, center = TRUE, scale = TRUE)
View(fish_w_cov)

fish_cov_mrf <- MRFcov(data = fish_w_cov, n_nodes = 6, family = "binomial") # symmetrise = mean

```

Plot co-occurrence
```{r Co-occurrence matrix with covariates}
# png("co_occurrence.png")
plotMRF_hm(fish_cov_mrf)
# dev.off()

```

Now let's explore relationships
```{r GRAPH with covariates}
fishcov_network <- graph.adjacency(fish_cov_mrf$graph, weighted = T, mode = "undirected")

# png("stationary_network_with_cov_nolabs.png")
plot.igraph(fishcov_network, layout = layout.circle(fishcov_network),
            edge.width = abs(E(fishcov_network)$weight),
            edge.color = ifelse(E(fishcov_network)$weight < 0,
                                'slateblue',
                                'darkred'),
            vertex.color = 'wheat',
            vertex.label = NA
            # vertex.label.family = "Verdana",
            # vertex.label.color = "azure4",
            # vertex.label.dist = 2,
            # vertex.label.cex = 1,
            # label.degree = pi/4
            )
# dev.off()


# === vertex label
vertex.label = LETTERS[1:10],         # Character vector used to label the nodes
vertex.label.color = "white",
vertex.label.family = "Times",        # Font family of the label (e.g.“Times”, “Helvetica”)
vertex.label.font = 2,                # Font: 1 plain, 2 bold, 3, italic, 4 bold italic, 5 symbol
vertex.label.cex = 1,                 # Font size (multiplication factor, device-dependent)
vertex.label.dist = 0,                # Distance between the label and the vertex
vertex.label.degree = 0,              # The position of the label in relation to the vertex (use pi)
```

A key step in the process of model exploration is to determine whether inclusion of covariates actually improves
model fit and is warranted when estimating interaction parameters. (from vignette(Bird.parasites))
```{r check covariate effect}
mod_fits <- cv_MRF_diag_rep(data = fish_w_cov, n_nodes = 6, n_cores = 1, family = 'binomial',
                            plot = F, compare_null = T, n_folds = 10)

# CRF (with covariates) model sensitivity
quantile(mod_fits$mean_sensitivity[mod_fits$model == 'CRF'], probs = c(0.05, 0.95))

# MRF (no covariates) model sensitivity
quantile(mod_fits$mean_sensitivity[mod_fits$model != 'CRF'], probs = c(0.05, 0.95))

```

I think this means covariate improves the model...

Ok, so far this was giving me one "snapshot". Now I want to create graphs for 3 temperature ranges:

```{r Preps}
# Fish matrices/data frames
fish_df <- read.csv(file = "fish sample matrix.csv", header = TRUE)
fish_mat <- read.csv(file = "fish sample matrix.csv", header = TRUE, row.names = 1) %>% as.matrix()

# Temperature tables
low_temp <- read.csv("low_temp_sites.csv", header = TRUE)
med_temp <- read.csv("medium_temp_sites.csv", header = TRUE)
high_temp <- read.csv("high_temp_sites.csv", header = TRUE)

```


## Low temperature ##

```{r MRFcov Fish with covariates - Low temp, warning=FALSE}
lowtemp_model <- inner_join(fish_df, low_temp, by = 'site', na_matches = "never")
row.names(lowtemp_model) <- lowtemp_model$site
lowtemp_model$site <- NULL
lowtemp_model$max_temp <- scale(lowtemp_model$max_temp,
                                center = TRUE, scale = TRUE) # standardise temperatures (mean = 0; sd = 1)

View(lowtemp_model)

low_mrf <- MRFcov(data = lowtemp_model, n_nodes = 6, family = "gaussian") # symmetrise = mean
# I'm using gaussian just because it tells me there are non-binary data (but I cant find them. I noticed it's a lot faster)
# Note: D. sargus are always present and S. rubrum are always absent here

```

Plot co-occurrence
```{r Co-occurrence matrix with covariates - Low temp}
# png("co_occurrence_low.png")
plotMRF_hm(low_mrf)
# dev.off()

```

Now let's explore relationships
```{r GRAPH with covariates - Low temp}
lowmod_network <- graph.adjacency(low_mrf$graph, weighted = T, mode = "undirected")

# png("low temp network.png")
plot.igraph(lowmod_network, layout = layout.circle(lowmod_network),
            edge.width = abs(E(lowmod_network)$weight),
            edge.color = ifelse(E(lowmod_network)$weight < 0,
                                'slateblue',
                                'darkred'),
            vertex.color = 'wheat',
            vertex.label.family = "Ariel",
            vertex.label.color = "azure4",
            vertex.label.dist = 2,
            vertex.label.degree = -20)
# dev.off()

```

## Medium temperature ##

```{r MRFcov Fish with covariates - Med temp, warning=FALSE}
medtemp_model <- inner_join(fish_df, med_temp, by = 'site', na_matches = "never")
row.names(medtemp_model) <- medtemp_model$site
medtemp_model$site <- NULL
medtemp_model$max_temp <- scale(medtemp_model$max_temp,
                                center = TRUE, scale = TRUE) # standardise temperatures (mean = 0; sd = 1)

View(medtemp_model)

med_mrf <- MRFcov(data = medtemp_model, n_nodes = 6, family = "gaussian") # symmetrise = mean
# Note: D. sargus are always present

```
Plot co-occurrence:
```{r Co-occurrence matrix with covariates - Med temp}
# png("co_occurrence_med.png")
plotMRF_hm(med_mrf)
# dev.off()

```

Now let's explore relationships
```{r GRAPH with covariates - Med temp}
medmod_network <- graph.adjacency(med_mrf$graph, weighted = T, mode = "undirected")

# png("med temp network.png")
plot.igraph(medmod_network, layout = layout.circle(medmod_network),
            edge.width = abs(E(medmod_network)$weight),
            edge.color = ifelse(E(medmod_network)$weight < 0,
                                'slateblue',
                                'darkred'),
            vertex.color = 'wheat',
            vertex.label.family = "Ariel",
            vertex.label.color = "azure4",
            vertex.label.dist = 2,
            vertex.label.degree = -20)
# dev.off()

```

## High temperature ##
```{r MRFcov Fish with covariates - High temp, warning=FALSE}
hitemp_model <- inner_join(fish_df, high_temp, by = 'site', na_matches = "never")
row.names(hitemp_model) <- hitemp_model$site
hitemp_model$site <- NULL
hitemp_model$max_temp <- scale(hitemp_model$max_temp,
                                center = TRUE, scale = TRUE) # standardise temperatures (mean = 0; sd = 1)

View(hitemp_model)

hi_mrf <- MRFcov(data = hitemp_model, n_nodes = 6, family = "gaussian") # symmetrise = mean

```
Plot co-occurrence:
```{r Co-occurrence matrix with covariates - High temp}
# png("co_occurrence_hi.png")
plotMRF_hm(hi_mrf)
# dev.off()

```

Now let's explore relationships
```{r GRAPH with covariates - High temp}
himod_network <- graph.adjacency(hi_mrf$graph, weighted = T, mode = "undirected")

# png("hi temp network.png")
plot.igraph(himod_network, layout = layout.circle(himod_network),
            edge.width = abs(E(himod_network)$weight),
            edge.color = ifelse(E(himod_network)$weight < 0,
                                'slateblue',
                                'darkred'),
            vertex.color = 'wheat',
            vertex.label.family = "Ariel",
            vertex.label.color = "azure4",
            vertex.label.dist = 2,
            vertex.label.degree = -20)
# dev.off()

```

AWESOME!