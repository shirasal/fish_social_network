---
title: "Results"
output: html_notebook
---

**How fish communities change along environmental gradients?**

Species associations are represented graphically and quantitatively using *MRFcov package* [^1].

# Set up
```{r Load packages, functions and data, message=FALSE, warning=FALSE}

source("scripts/pckgs_preps.R")
source("scripts/model_func.R")

```

# Mediterranean networks

Networks for the whole Mediterranean sea, accounting for spatial autocorrelation.

## Groupers
```{r}
# Create datasets for each covariate

# Temperature
groupers_temp <- create_spp_mat(dataset = med_raw, basin = all_med,
                                group = groupers, covariate = "tmean_reg")
# MPA
groupers_mpa <- create_spp_mat(dataset = med_raw, basin = all_med,
                               group = groupers, covariate = "mpa")

# Depth
groupers_depth <- create_spp_mat(dataset = med_raw, basin = all_med,
                                 group = groupers, covariate = "depth_reg")


groupers_temp_mat <- groupers_temp[[1]]
groupers_temp_coords <- groupers_temp[[2]]
nrow(groupers_temp_mat) == nrow(groupers_temp_coords)

groupers_mpa_mat <- groupers_mpa[[1]]
groupers_mpa_coords <- groupers_mpa[[2]]
nrow(groupers_mpa_mat) == nrow(groupers_mpa_coords)

groupers_depth_mat <- groupers_depth[[1]]
groupers_depth_coords <- groupers_depth[[2]]
nrow(groupers_depth_mat) == nrow(groupers_depth_coords)

```

### Model for Temperature
```{r include=FALSE}
# Run model and create occurrence predictions
model_temp_grps <- run_mod(species_mat = groupers_temp_mat, n_covs = 1,
                           family = "gaussian", coords = groupers_temp_coords)
```

I'll run also the model without accounting for spatial autocorrelation and see if there are differences
```{r}
# Non-spatial model for comparison
model_temp_grps_nonspat <- MRFcov(data = groupers_temp_mat, n_nodes = 5, n_covariates = 1,
                                  family = "gaussian")
model_temp_grps_nonspat$direct_coefs
plotMRF_hm(model_temp_grps_nonspat, main = "Species association coefficients")

```

Yes, there is a difference but it's subtle so the heatmap is still pretty good visualisation.

```{r}
model_temp_grps$mod$direct_coefs
model_temp_grps$boot$mean_key_coefs

# Occurrence predictions
predict_temp_grps <- model_temp_grps$pred

```

#### Visualising the change along a temperature gradient

```{r}
# Categorise continuous data
grps_temp_cats <- categorise_cov(species_mat = groupers_temp_mat, covariate = "tmean_reg")

# Nest categorical (nominal) data
grps_temp_cat_nested <- nested_data(categorised_data = grps_temp_cats)

# Run MRFcov model for each sub-graph
grps_temp_cat_model <- get_model(data = groupers_temp_mat, ncov = 1)

# Run model on each category
grps_temp_nested_mod <- nested_models(nested_df = grps_temp_cat_nested)

# Get graph data
grps_temp_nested_plot <- grps_temp_nested_mod %>% mutate(plot = map(model, get_graph))

# Plot multiple graphs for gradient
grps_temp_graph <- plot_multi_graphs(nested_df = grps_temp_nested_plot, n_graphs = 3)

# png("figures/groupers_allmed_temp.png", height = 450, width = 1200, res = 150)
# plot_multi_graphs(nested_df = grps_temp_nested_plot, n_graphs = 3)
# dev.off()

```

### Model for MPAs
```{r include=FALSE}
# Run model and create occurrence predictions
model_mpa_grps <- run_mod(species_mat = groupers_mpa_mat, n_covs = 1,
                           family = "gaussian", coords = groupers_mpa_coords)
```

```{r}
# Non-spatial model for comparison
model_mpa_grps_nonspat <- MRFcov(data = groupers_mpa_mat, n_nodes = 5, n_covariates = 1,
                                  family = "gaussian")
model_mpa_grps_nonspat$direct_coefs
plotMRF_hm(model_mpa_grps_nonspat, main = "Species association coefficients")

```

```{r}
model_mpa_grps$mod$direct_coefs
model_mpa_grps$boot$mean_key_coefs

# Occurrence predictions
predict_mpa_grps <- model_mpa_grps$pred

# # Take a look at the mean coefficients
# plotMRF_hm(model_mpa_grps$graph, main = "Association coeffiecients for grouper species")
# # FIXME this isn't working at the moment because the output of MRFcov_spatial is not like MRFcov
# # There is no graph object

```

#### Visualising the change between inside and outside of MPAs

```{r}
# Nest categorical data
grps_mpa_cat_nested <- nested_data(categorised_data = as.data.frame(groupers_mpa_mat))

# Run MRFcov model for each sub-graph
grps_mpa_cat_model <- get_model(data = groupers_mpa_mat, ncov = 1)

# Run model on each category
grps_mpa_nested_mod <- nested_models(nested_df = grps_mpa_cat_nested)

# Get graph data
grps_mpa_nested_plot <- grps_mpa_nested_mod %>% mutate(plot = map(model, get_graph))

# Plot multiple graphs for gradient
grps_mpa_graph <- plot_multi_graphs(nested_df = grps_mpa_nested_plot, n_graphs = 2)

# png("figures/groupers_allmed_mpa.png", height = 450, width = 1200, res = 150)
# plot_multi_graphs(nested_df = grps_mpa_nested_plot, n_graphs = 2)
# dev.off()

```

### Model for depth
```{r include=FALSE}
# Run model and create occurrence predictions
model_depth_grps <- run_mod(species_mat = groupers_depth_mat, n_covs = 1,
                           family = "gaussian", coords = groupers_depth_coords)
```

```{r}
# Non-spatial model for comparison
model_depth_grps_nonspat <- MRFcov(data = groupers_depth_mat, n_nodes = 5, n_covariates = 1,
                                  family = "gaussian")
model_depth_grps_nonspat$direct_coefs
plotMRF_hm(model_temp_grps_nonspat, main = "Species association coefficients")

```

```{r}
model_depth_grps$mod$direct_coefs
model_depth_grps$boot$mean_key_coefs

# Occurrence predictions
predict_depth_grps <- model_depth_grps$pred

# # Take a look at the mean coefficients
# plotMRF_hm(model_depth_grps$graph, main = "Association coeffiecients for grouper species")
# # FIXME this isn't working at the moment because the output of MRFcov_spatial is not like MRFcov
# # There is no graph object

```

#### Visualising the change along a depth gradient

This is problematic because the depth range is not distributed well enough:

```{r}
# # Categorise continuous data
# grps_depth_cats <- categorise_cov(species_mat = groupers_depth_mat, covariate = "depth_reg")
# 
# # Nest categorical (nominal) data
# grps_depth_cat_nested <- nested_data(categorised_data = grps_depth_cats)
# 
# # Run MRFcov model for each sub-graph
# grps_depth_cat_model <- get_model(data = groupers_depth_mat, ncov = 1)
# 
# # Run model on each category
# grps_depth_nested_mod <- nested_models(nested_df = grps_depth_cat_nested)
# 
# # Get graph data
# grps_depth_nested_plot <- grps_depth_nested_mod %>% mutate(plot = map(model, get_graph))
# 
# # Plot multiple graphs for gradient
# grps_depth_graph <- plot_multi_graphs(nested_df = grps_depth_nested_plot, n_graphs = 3)
# 
# # png("figures/groupers_allmed_depth.png", height = 450, width = 1200, res = 150)
# # plot_multi_graphs(nested_df = grps_depth_nested_plot, n_graphs = 3)
# # dev.off()

groupers_depth <- med_raw %>% filter(species == groupers)
ggplot(groupers_depth) +
  geom_histogram(aes(x = depth, fill = data.origin), binwidth = 1)

```

## Diplodus
```{r}
# Create datasets for each covariate

# Temperature
dip_temp <- create_spp_mat(dataset = med_raw, basin = all_med,
                                group = diplodus, covariate = "tmean_reg")
# MPA
dip_mpa <- create_spp_mat(dataset = med_raw, basin = all_med,
                               group = diplodus, covariate = "mpa")

# Depth
dip_depth <- create_spp_mat(dataset = med_raw, basin = all_med,
                                 group = diplodus, covariate = "depth_reg")

dip_temp_mat <- dip_temp[[1]]
dip_temp_coords <- dip_temp[[2]]
nrow(dip_temp_mat) == nrow(dip_temp_coords)

dip_mpa_mat <- dip_mpa[[1]]
dip_mpa_coords <- dip_mpa[[2]]
nrow(dip_mpa_mat) == nrow(dip_mpa_coords)

dip_depth_mat <- dip_depth[[1]]
dip_depth_coords <- dip_depth[[2]]
nrow(dip_depth_mat) == nrow(dip_depth_coords)

```

### Model for Temperature
```{r include=FALSE}
# Run model and create occurrence predictions
model_temp_dip <- run_mod(species_mat = dip_temp_mat, n_covs = 1,
                           family = "gaussian", coords = dip_temp_coords)
```

```{r}
# Non-spatial model for comparison
model_temp_dip_nonspat <- MRFcov(data = dip_temp_mat, n_nodes = length(diplodus), n_covariates = 1,
                                  family = "gaussian")
model_temp_dip_nonspat$direct_coefs
plotMRF_hm(model_temp_dip_nonspat, main = "Species association coefficients")

```

```{r}
model_temp_dip$mod$direct_coefs
model_temp_dip$boot$mean_key_coefs

# Occurrence predictions
predict_temp_dip <- model_temp_dip$pred

# # Take a look at the mean coefficients
# plotMRF_hm(model_temp_dip$graph, main = "Association coeffiecients for diplodus species")
# # FIXME this isn't working at the moment because the output of MRFcov_spatial is not like MRFcov
# # There is no graph object

```

#### Visualising the change along a temperature gradient

```{r}
# Categorise continuous data
dip_temp_cats <- categorise_cov(species_mat = dip_temp_mat, covariate = "tmean_reg")

# Nest categorical (nominal) data
dip_temp_cat_nested <- nested_data(categorised_data = dip_temp_cats)

# Run MRFcov model for each sub-graph
dip_temp_cat_model <- get_model(data = dip_temp_mat, ncov = 1)

# Run model on each category
dip_temp_nested_mod <- nested_models(nested_df = dip_temp_cat_nested)

# Get graph data
dip_temp_nested_plot <- dip_temp_nested_mod %>% mutate(plot = map(model, get_graph))

# Plot multiple graphs for gradient
dip_temp_graph <- plot_multi_graphs(nested_df = dip_temp_nested_plot, n_graphs = 3)

# png("figures/dip_allmed_temp.png", height = 450, width = 1200, res = 150)
# plot_multi_graphs(nested_df = dip_temp_nested_plot, n_graphs = 3)
# dev.off()

```

### Model for MPAs
```{r include=FALSE}
# Run model and create occurrence predictions
model_mpa_dip <- run_mod(species_mat = dip_mpa_mat, n_covs = 1,
                           family = "gaussian", coords = dip_mpa_coords)
```

```{r}
# Non-spatial model for comparison
model_mpa_dip_nonspat <- MRFcov(data = dip_mpa_mat, n_nodes = length(diplodus), n_covariates = 1,
                                  family = "gaussian")
model_mpa_dip_nonspat$direct_coefs
plotMRF_hm(model_mpa_dip_nonspat, main = "Species association coefficients")

```

```{r}
model_mpa_dip$mod$direct_coefs
model_mpa_dip$boot$mean_key_coefs

# Occurrence predictions
predict_mpa_dip <- model_mpa_dip$pred

# # Take a look at the mean coefficients
# plotMRF_hm(model_mpa_dip$graph, main = "Association coeffiecients for grouper species")
# # FIXME this isn't working at the moment because the output of MRFcov_spatial is not like MRFcov
# # There is no graph object

```

#### Visualising the change between inside and outside of MPAs

```{r}
# Nest categorical data
dip_mpa_cat_nested <- nested_data(categorised_data = as.data.frame(dip_mpa_mat))

# Run MRFcov model for each sub-graph
dip_mpa_cat_model <- get_model(data = dip_mpa_mat, ncov = 1)

# Run model on each category
dip_mpa_nested_mod <- nested_models(nested_df = dip_mpa_cat_nested)

# Get graph data
dip_mpa_nested_plot <- dip_mpa_nested_mod %>% mutate(plot = map(model, get_graph))

# Plot multiple graphs for gradient
dip_mpa_graph <- plot_multi_graphs(nested_df = dip_mpa_nested_plot, n_graphs = 2)

# png("figures/dip_allmed_mpa.png", height = 450, width = 1200, res = 150)
# plot_multi_graphs(nested_df = dip_mpa_nested_plot, n_graphs = 2)
# dev.off()

```

### Model for depth
```{r include=FALSE}
# Run model and create occurrence predictions
model_depth_dip <- run_mod(species_mat = dip_depth_mat, n_covs = 1,
                           family = "gaussian", coords = dip_depth_coords)
```

```{r}
# Non-spatial model for comparison
model_depth_dip_nonspat <- MRFcov(data = dip_depth_mat, n_nodes = length(diplodus), n_covariates = 1,
                                  family = "gaussian")
model_depth_dip_nonspat$direct_coefs
plotMRF_hm(model_depth_dip_nonspat, main = "Species association coefficients")

```

```{r}
model_depth_dip$mod$direct_coefs
model_depth_dip$boot$mean_key_coefs

# Occurrence predictions
predict_depth_dip <- model_depth_dip$pred

# # Take a look at the mean coefficients
# plotMRF_hm(model_depth_dip$graph, main = "Association coeffiecients for grouper species")
# # FIXME this isn't working at the moment because the output of MRFcov_spatial is not like MRFcov
# # There is no graph object

```

#### Visualising the change along a depth gradient

```{r}
# # Categorise continuous data
# dip_depth_cats <- categorise_cov(species_mat = dip_depth_mat, covariate = "depth_reg")
# 
# # Nest categorical (nominal) data
# dip_depth_cat_nested <- nested_data(categorised_data = dip_depth_cats)
# 
# # Run MRFcov model for each sub-graph
# dip_depth_cat_model <- get_model(data = dip_depth_mat, ncov = 1)
# 
# # Run model on each category
# dip_depth_nested_mod <- nested_models(nested_df = dip_depth_cat_nested)
# 
# # Get graph data
# dip_depth_nested_plot <- dip_depth_nested_mod %>% mutate(plot = map(model, get_graph))
# 
# # Plot multiple graphs for gradient
# dip_depth_graph <- plot_multi_graphs(nested_df = dip_depth_nested_plot, n_graphs = 3)
# 
# # png("figures/dip_allmed_depth.png", height = 450, width = 1200, res = 150)
# # plot_multi_graphs(nested_df = dip_depth_nested_plot, n_graphs = 3)
# # dev.off()

diplodus_depth <- med_raw %>% filter(species == diplodus)
ggplot(diplodus_depth) +
  geom_histogram(aes(x = depth, fill = data.origin), binwidth = 1)

```

## Herbivores
```{r}
# Create datasets for each covariate

# Temperature
herb_temp <- create_spp_mat(dataset = med_raw, basin = all_med,
                                group = herbivores, covariate = "tmean_reg")
# MPA
herb_mpa <- create_spp_mat(dataset = med_raw, basin = all_med,
                               group = herbivores, covariate = "mpa")

# Depth
herb_depth <- create_spp_mat(dataset = med_raw, basin = all_med,
                                 group = herbivores, covariate = "depth_reg")

herb_temp_mat <- herb_temp[[1]]
herb_temp_coords <- herb_temp[[2]]
nrow(herb_temp_mat) == nrow(herb_temp_coords)

herb_mpa_mat <- herb_mpa[[1]]
herb_mpa_coords <- herb_mpa[[2]]
nrow(herb_mpa_mat) == nrow(herb_mpa_coords)

herb_depth_mat <- herb_depth[[1]]
herb_depth_coords <- herb_depth[[2]]
nrow(herb_depth_mat) == nrow(herb_depth_coords)

```

### Model for Temperature
```{r include=FALSE}
# Run model and create occurrence predictions
model_temp_herb <- run_mod(species_mat = herb_temp_mat, n_covs = 1,
                           family = "gaussian", coords = herb_temp_coords)
```

```{r}
# Non-spatial model for comparison
model_temp_herb_nonspat <- MRFcov(data = herb_temp_mat, n_nodes = length(hebivores), n_covariates = 1,
                                  family = "gaussian")
model_temp_herb_nonspat$direct_coefs
plotMRF_hm(model_temp_herb_nonspat, main = "Species association coefficients")

```

```{r}
model_temp_herb$mod$direct_coefs
model_temp_herb$boot$mean_key_coefs

# Occurrence predictions
predict_temp_herb <- model_temp_herb$pred

# # Take a look at the mean coefficients
# plotMRF_hm(model_temp_herb$graph, main = "Association coeffiecients for herbivorous species")
# # FIXME this isn't working at the moment because the output of MRFcov_spatial is not like MRFcov
# # There is no graph object

```

#### Visualising the change along a temperature gradient

```{r}
# Categorise continuous data
herb_temp_cats <- categorise_cov(species_mat = herb_temp_mat, covariate = "tmean_reg")

# Nest categorical (nominal) data
herb_temp_cat_nested <- nested_data(categorised_data = herb_temp_cats)

# Run MRFcov model for each sub-graph
herb_temp_cat_model <- get_model(data = herb_temp_mat, ncov = 1)

# Run model on each category
herb_temp_nested_mod <- nested_models(nested_df = herb_temp_cat_nested)

# Get graph data
herb_temp_nested_plot <- herb_temp_nested_mod %>% mutate(plot = map(model, get_graph))

# Plot multiple graphs for gradient
herb_temp_graph <- plot_multi_graphs(nested_df = herb_temp_nested_plot, n_graphs = 3)

# png("figures/herb_allmed_temp.png", height = 450, width = 1200, res = 150)
# plot_multi_graphs(nested_df = herb_temp_nested_plot, n_graphs = 3)
# dev.off()

```

### Model for MPAs
```{r include=FALSE}
# Run model and create occurrence predictions
model_mpa_herb <- run_mod(species_mat = herb_mpa_mat, n_covs = 1,
                           family = "gaussian", coords = herb_mpa_coords)
```

```{r}
# Non-spatial model for comparison
model_mpa_herb_nonspat <- MRFcov(data = herb_mpa_mat, n_nodes = length(hebivores), n_covariates = 1,
                                  family = "gaussian")
model_mpa_herb_nonspat$direct_coefs
plotMRF_hm(model_mpa_herb_nonspat, main = "Species association coefficients")

```

```{r}
model_mpa_herb$mod$direct_coefs
model_mpa_herb$boot$mean_key_coefs

# Occurrence predictions
predict_mpa_herb <- model_mpa_herb$pred

# # Take a look at the mean coefficients
# plotMRF_hm(model_mpa_herb$graph, main = "Association coeffiecients for grouper species")
# # FIXME this isn't working at the moment because the output of MRFcov_spatial is not like MRFcov
# # There is no graph object

```

#### Visualising the change between inside and outside of MPAs

```{r}
# Nest categorical data
herb_mpa_cat_nested <- nested_data(categorised_data = as.data.frame(herb_mpa_mat))

# Run MRFcov model for each sub-graph
herb_mpa_cat_model <- get_model(data = herb_mpa_mat, ncov = 1)

# Run model on each category
herb_mpa_nested_mod <- nested_models(nested_df = herb_mpa_cat_nested)

# Get graph data
herb_mpa_nested_plot <- herb_mpa_nested_mod %>% mutate(plot = map(model, get_graph))

# Plot multiple graphs for gradient
herb_mpa_graph <- plot_multi_graphs(nested_df = herb_mpa_nested_plot, n_graphs = 2)

# png("figures/herb_allmed_mpa.png", height = 450, width = 1200, res = 150)
# plot_multi_graphs(nested_df = herb_mpa_nested_plot, n_graphs = 2)
# dev.off()

```

### Model for depth
```{r include=FALSE}
# Run model and create occurrence predictions
model_depth_herb <- run_mod(species_mat = herb_depth_mat, n_covs = 1,
                           family = "gaussian", coords = herb_depth_coords)
```

```{r}
# Non-spatial model for comparison
model_depth_herb_nonspat <- MRFcov(data = herb_depth_mat, n_nodes = length(hebivores), n_covariates = 1,
                                  family = "gaussian")
model_depth_herb_nonspat$direct_coefs
plotMRF_hm(model_depth_herb_nonspat, main = "Species association coefficients")

```

```{r}
model_depth_herb$mod$direct_coefs
model_depth_herb$boot$mean_key_coefs

# Occurrence predictions
predict_depth_herb <- model_depth_herb$pred

# # Take a look at the mean coefficients
# plotMRF_hm(model_depth_herb$graph, main = "Association coeffiecients for grouper species")
# # FIXME this isn't working at the moment because the output of MRFcov_spatial is not like MRFcov
# # There is no graph object

```

#### Visualising the change along a depth gradient

```{r}
# Categorise continuous data
herb_depth_cats <- categorise_cov(species_mat = herb_depth_mat, covariate = "depth_reg")

# Nest categorical (nominal) data
herb_depth_cat_nested <- nested_data(categorised_data = herb_depth_cats)

# Run MRFcov model for each sub-graph
herb_depth_cat_model <- get_model(data = herb_depth_mat, ncov = 1)

# Run model on each category
herb_depth_nested_mod <- nested_models(nested_df = herb_depth_cat_nested)

# Get graph data
herb_depth_nested_plot <- herb_depth_nested_mod %>% mutate(plot = map(model, get_graph))

# Plot multiple graphs for gradient
herb_depth_graph <- plot_multi_graphs(nested_df = herb_depth_nested_plot, n_graphs = 3)

# png("figures/herb_allmed_depth.png", height = 450, width = 1200, res = 150)
# plot_multi_graphs(nested_df = herb_depth_nested_plot, n_graphs = 3)
# dev.off()

```

# Data visualisations

## Covariates

### Temperature distribution
```{r echo=FALSE}
ggplot(med_raw, aes(tmean)) + geom_histogram(binwidth = 0.5, aes(fill = ..x..)) +
  labs(x = "Mean annual temperature", y = "Frequency", title = "Temperature") +
  guides(fill = FALSE)


```

### Depth distribution
```{r echo=FALSE}
ggplot(med_raw, aes(depth)) + geom_histogram(binwidth = 1, aes(fill = ..x..)) +
  labs(x = "Depth of transect", y = "Frequency", title = "Depth") +
  guides(fill = FALSE)

```

### MPAs (enforcement) distribution
```{r echo=FALSE}
ggplot(med_raw, aes(enforcement)) + geom_histogram(binwidth = 1, aes(fill = ..x..)) +
  labs(x = "Level of enforcement", subtitle = "0 = No enforcement; 3 = Fully protected",
       y = "Frequency", title = "Enforcement") +
  guides(fill = FALSE)

```


___

[^1]: Clark, Nicholas J., Konstans Wells, and Oscar Lindberg. "Unravelling changing interspecific interactions across environmental gradients using Markov random fields." Ecology 99.6 (2018): 1277-1283.